{"version":3,"sources":["webpack://MPADiff/webpack/universalModuleDefinition","webpack://MPADiff/webpack/bootstrap","webpack://MPADiff/webpack/runtime/define property getters","webpack://MPADiff/webpack/runtime/hasOwnProperty shorthand","webpack://MPADiff/webpack/runtime/make namespace object","webpack://MPADiff/./src/lib/utils/DOM.ts","webpack://MPADiff/./src/lib/utils/LinksObserver.ts","webpack://MPADiff/./src/lib/utils/network.ts","webpack://MPADiff/./src/lib/utils/URL.ts","webpack://MPADiff/./src/lib/index.ts","webpack://MPADiff/./src/lib/utils/common.ts"],"names":["root","factory","exports","module","define","amd","self","__webpack_require__","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","STYLESHEET_SELECTOR","LinksObserver","this","defaultDelay","callback","delay","links","length","linksHTML","seenLinks","undefined","outerHTML","Array","from","document","getElementsByTagName","didChange","map","link","window","setTimeout","timedHandler","setDelay","setCallback","urls","fetchURL","url","cache","didFetch","errored","promise","fetch","then","resp","text","html","error","console","isHrefSameHost","href","startsWith","getHost","location","origin","isHrefSameHostAbsolute","split","pop","shift","MPA_ATTRIBUTE_EVENT_LISTENER","MBA_ATTRIBUTE_TRUE","MPADiff","config","DEFAULT_CONFIG","defaultLoaderDelay","loaderDelay","eagerLoading","loaderElement","observer","init","handleLinksChange","bind","onpopstate","handlePopState","MPADiffInstance","instance","e","updateHTML","state","htmlString","newDOM","DOMParser","parseFromString","currentStyles","newStyles","querySelectorAll","forEach","el","i","keys","style","createElement","rel","head","appendChild","remove","cloneNode","body","innerHTML","render","title","history","pushState","addEventListener","preventDefault","shouldRevertToDefaultBehaviour","Error","Promise","resolve","getURLContent","log","updateBrowserHistory","startIdx","search","endIdx","slice","getTitleFromHtml","setAttribute","getAttribute","addListener","loader"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"MPADiff\"] = factory();\n\telse\n\t\troot[\"MPADiff\"] = factory();\n})(self, function() {\nreturn ","// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const STYLESHEET_SELECTOR = 'link[rel=\"stylesheet\"]';\n\nexport function render(document: Document, htmlString: string) {\n  const parser = new DOMParser();\n  const newDOM = parser.parseFromString(htmlString, \"text/html\");\n\n  const currentStyles: Record<string, number> = {};\n  const newStyles: Record<string, number> = {};\n  document\n    .querySelectorAll(STYLESHEET_SELECTOR)\n    .forEach((el: HTMLLinkElement, i) => {\n      currentStyles[el.href] = i;\n    });\n\n  newDOM\n    .querySelectorAll(STYLESHEET_SELECTOR)\n    .forEach((el: HTMLLinkElement, i) => {\n      newStyles[el.href] = i;\n    });\n\n  //Add styles that are not in currentStyles\n  Object.keys(newStyles).forEach((href) => {\n    if (currentStyles[href] === undefined) {\n      const style = document.createElement(\"link\");\n      style.href = href;\n      style.rel = \"stylesheet\";\n      document.head.appendChild(style);\n    }\n  });\n  //Remove styles that are not in newStyles\n  Object.keys(currentStyles).forEach((href) => {\n    if (newStyles[href] === undefined) {\n      document\n        .querySelectorAll(STYLESHEET_SELECTOR)\n        [currentStyles[href]]?.remove();\n    }\n  });\n\n  //Remove non style tags from current DOM\n  document.head\n    .querySelectorAll(`:not(${STYLESHEET_SELECTOR})`)\n    .forEach((el) => {\n      el.remove();\n    });\n  // Add non style tags to current dom that exists in the new DOM\n  newDOM.head.querySelectorAll(`:not(${STYLESHEET_SELECTOR})`).forEach((el) => {\n    document.head.appendChild(el.cloneNode(true));\n  });\n\n  // Replace body element...\n  document.body.innerHTML = newDOM.body.innerHTML;\n}\n","type CallbackType = (links: HTMLAnchorElement[]) => void;\n\nexport class LinksObserver {\n  private callback: CallbackType = () => {};\n  private defaultDelay = 300;\n  private delay: number = this.defaultDelay;\n  private linksHTML: string[] = [];\n\n  setCallback(callback: CallbackType) {\n    this.callback = callback;\n  }\n\n  setDelay(delay: number) {\n    this.delay = delay;\n    this.defaultDelay = delay;\n  }\n\n  private didChange(links: HTMLAnchorElement[]) {\n    if (links.length !== this.linksHTML.length) return true;\n    const seenLinks: Record<string, number> = {}; //link => count\n\n    for (const linkHTML of this.linksHTML) {\n      seenLinks[linkHTML] = 0;\n    }\n\n    for (const link of links) {\n      const countSeen = seenLinks[link.outerHTML];\n      if (countSeen === undefined) return true;\n    }\n  }\n\n  private timedHandler() {\n    const links = Array.from(document.getElementsByTagName(\"a\"));\n    if (!this.didChange(links)) {\n      window.setTimeout(() => this.timedHandler(), this.delay);\n      return;\n    } else {\n      this.delay = this.defaultDelay;\n    }\n    this.linksHTML = links.map((link) => link.outerHTML);\n\n    this.callback(links);\n    window.setTimeout(() => this.timedHandler(), this.delay);\n  }\n\n  init(callback: CallbackType, delay = this.delay) {\n    this.setDelay(delay);\n    this.setCallback(callback);\n    this.timedHandler();\n  }\n}\n","type URLObject = {\n  didFetch: boolean;\n  html?: string;\n  promise?: Promise<string>;\n  errored: boolean;\n};\n\nconst urls: Record<string, URLObject> = {};\n\nexport function fetchURL(url: string, cache = urls) {\n  if (cache[url]) return;\n  cache[url] = {\n    didFetch: false,\n    errored: false,\n    promise: fetch(url)\n      .then((resp) => resp.text())\n      .then((html) => {\n        urls[url].didFetch = true;\n        urls[url].html = html;\n        return html;\n      })\n      .catch((error) => {\n        console.error(error);\n        urls[url].errored = true;\n        urls[url].didFetch = true;\n        return \"\";\n      }),\n  };\n}\n\nexport function getURLContent(\n  url: string,\n  cache = urls\n): Promise<string | undefined> {\n  if (!cache[url])\n    throw new Error(`Couldn't find url: ${url} in saved records!`);\n  return new Promise<string | undefined>((resolve) => {\n    if (cache[url].didFetch) resolve(cache[url].html);\n\n    resolve(cache[url].promise?.then(() => cache[url].html));\n  });\n}\n","function isAbsoluteURL(url: string) {\n  return (\n    url.startsWith(\"http\") || url.startsWith(\"https\") || url.startsWith(\"//\")\n  );\n}\n\nexport function isHrefSameHost(href: string): boolean {\n  if (isAbsoluteURL(href)) return isHrefSameHostAbsolute(href);\n  return true;\n}\n\nfunction getHost(href: string) {\n  return href.split(\"//\").pop().split(\"/\").shift();\n}\n\nfunction isHrefSameHostAbsolute(href: string): boolean {\n  return getHost(href) === getHost(window.location.origin);\n}\n\nexport function getPath(href: string): string {\n  return href;\n}\n","import { getTitleFromHtml } from \"./utils/common\";\nimport { render } from \"./utils/DOM\";\nimport { LinksObserver } from \"./utils/LinksObserver\";\nimport { fetchURL, getURLContent } from \"./utils/network\";\nimport { isHrefSameHost } from \"./utils/URL\";\n\ntype Config = {\n  loaderDelay?: number;\n  eagerLoading?: boolean;\n  loaderElement?: Node;\n};\n\nconst MPA_ATTRIBUTE_EVENT_LISTENER = \"data-mpa-diff-added-listener\";\nconst MBA_ATTRIBUTE_TRUE = \"true\";\nclass MPADiff {\n  private observer = new LinksObserver();\n  private static instance: MPADiff | undefined = undefined;\n  private eagerLoading = true;\n  private defaultLoaderDelay = 500;\n  private loaderElement: Node | undefined = undefined;\n  private static DEFAULT_CONFIG: Config = {\n    loaderDelay: 500,\n    eagerLoading: true,\n    loaderElement: undefined,\n  };\n  private constructor(config = MPADiff.DEFAULT_CONFIG) {\n    this.defaultLoaderDelay =\n      config.loaderDelay ?? MPADiff.DEFAULT_CONFIG.loaderDelay;\n    this.eagerLoading =\n      config.eagerLoading ?? MPADiff.DEFAULT_CONFIG.eagerLoading;\n    this.loaderElement =\n      config.loaderElement ?? MPADiff.DEFAULT_CONFIG.loaderElement;\n\n    this.observer.init(this.handleLinksChange.bind(this));\n    window.onpopstate = this.handlePopState.bind(this);\n  }\n\n  static init(config?: Config): void {\n    if ((window as any).MPADiffInstance) return;\n    if (MPADiff.instance) return;\n    MPADiff.instance = new MPADiff(config);\n    (window as any).MPADiffInstance = this.instance;\n    return;\n  }\n\n  static getInstance(): MPADiff {\n    if (!MPADiff.instance) {\n      this.init();\n    }\n    return MPADiff.instance;\n  }\n  private handlePopState(e: PopStateEvent) {\n    this.updateHTML(e.state.html);\n  }\n\n  private updateHTML(htmlString: string) {\n    render(document, htmlString);\n  }\n\n  private updateBrowserHistory(html: string, href: string, title: string) {\n    history.pushState({ html }, title, href);\n  }\n\n  private addListener(link: HTMLAnchorElement) {\n    if (this.eagerLoading) {\n      fetchURL(link.href);\n    }\n    link.addEventListener(\"click\", (e) => {\n      e.preventDefault();\n      let shouldRevertToDefaultBehaviour = false;\n\n      if (this.loaderElement) {\n        document.body.appendChild(this.loaderElement);\n        this.loaderElement = this.loaderElement.cloneNode(true);\n      }\n      if (!this.eagerLoading) {\n        fetchURL(link.href);\n      }\n\n      getURLContent(link.href).then((html) => {\n        if (!html) {\n          console.log(\"Received empty/undefined html value: \", html);\n          console.log(\"Reverting to default behaviour\");\n          shouldRevertToDefaultBehaviour = true;\n          return;\n        }\n        window.setTimeout(() => {\n          this.updateHTML(html);\n          this.updateBrowserHistory(html, link.href, getTitleFromHtml(html));\n        }, this.defaultLoaderDelay);\n      });\n\n      if (shouldRevertToDefaultBehaviour) {\n        window.location.href = link.href;\n      }\n\n      return false;\n    });\n    link.setAttribute(MPA_ATTRIBUTE_EVENT_LISTENER, MBA_ATTRIBUTE_TRUE);\n  }\n\n  private handleLinksChange(links: HTMLAnchorElement[]) {\n    for (const link of links) {\n      if (\n        link.getAttribute(MPA_ATTRIBUTE_EVENT_LISTENER) === MBA_ATTRIBUTE_TRUE\n      )\n        continue;\n      if (!isHrefSameHost(link.href)) continue;\n      this.addListener(link);\n    }\n  }\n\n  setEagerLoading(eagerLoading: boolean) {\n    this.eagerLoading = eagerLoading;\n  }\n\n  setLoader(loader: HTMLElement | Node) {\n    this.loaderElement = loader.cloneNode(true);\n  }\n\n  setDefaultLoaderDelay(delay: number) {\n    this.defaultLoaderDelay = delay;\n  }\n}\nexport default MPADiff;\n","export function getTitleFromHtml(html: string): string {\n  const startIdx = html.search(/<title>.*<\\/title>/);\n  if (startIdx < 0) return \"\";\n  const endIdx = html.search(/<\\/title>/);\n  if (endIdx < 0) return \"\";\n  return html.slice(startIdx, endIdx).slice(\"<title>\".length);\n}\n"],"sourceRoot":""}